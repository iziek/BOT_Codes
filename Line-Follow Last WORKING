// Motor pins
const int motorLeftForward = A0;
const int motorLeftBackward = A1;
const int motorRightForward = A2;
const int motorRightBackward = A3;
const int pwmLeft = 9;
const int pwmRight = 10;

// IR sensor pins (leftmost to rightmost)
const int sensorPins[5] = {2, 3, 4, 5, 6};

// Motor speed settings
const int baseSpeed = 150;

// PID parameters
float Kp = 75.0;
float Ki = 0.0;
float Kd = 75.0;

int lastDirection = 0; // -1 = left, 0 = forward, 1 = right

// PID variables
float error = 0;
float lastError = 0;
float integral = 0;

unsigned long lastTime = 0;

void setup() {
  pinMode(motorLeftForward, OUTPUT);
  pinMode(motorLeftBackward, OUTPUT);
  pinMode(motorRightForward, OUTPUT);
  pinMode(motorRightBackward, OUTPUT);
  pinMode(pwmLeft, OUTPUT);
  pinMode(pwmRight, OUTPUT);

  for (int i = 0; i < 5; i++) {
    pinMode(sensorPins[i], INPUT);
  }

  Serial.begin(9600);
  lastTime = millis();
}

void setLeftMotor(int speed) {
  if (speed > 0) {
    analogWrite(pwmLeft, speed);
    digitalWrite(motorLeftForward, HIGH);
    digitalWrite(motorLeftBackward, LOW);
  } else if (speed < 0) {
    analogWrite(pwmLeft, -speed);
    digitalWrite(motorLeftForward, LOW);
    digitalWrite(motorLeftBackward, HIGH);
  } else {
    analogWrite(pwmLeft, 0);
    digitalWrite(motorLeftForward, LOW);
    digitalWrite(motorLeftBackward, LOW);
  }
}

void setRightMotor(int speed) {
  if (speed > 0) {
    analogWrite(pwmRight, speed);
    digitalWrite(motorRightForward, HIGH);
    digitalWrite(motorRightBackward, LOW);
  } else if (speed < 0) {
    analogWrite(pwmRight, -speed);
    digitalWrite(motorRightForward, LOW);
    digitalWrite(motorRightBackward, HIGH);
  } else {
    analogWrite(pwmRight, 0);
    digitalWrite(motorRightForward, LOW);
    digitalWrite(motorRightBackward, LOW);
  }
}

void loop() {
  int sensorReadings[5];
  int sensorWeights[5] = {-4, -2, 0, 2, 4};
  int countDetected = 0;
  long positionSum = 0;

  // Read sensors and invert for black line (LOW = line detected)
  for (int i = 0; i < 5; i++) {
    sensorReadings[i] = digitalRead(sensorPins[i]) == LOW ? 1 : 0;
    if (sensorReadings[i] == 1) {
      positionSum += sensorWeights[i];
      countDetected++;
    }
  }

  // Handle all sensors detecting white or all black:
  if (countDetected == 0 || countDetected == 5) {
    // Stop both motors to avoid continuous running
    setLeftMotor(0);
    setRightMotor(0);
    Serial.println("All sensors white or black - Motors stopped");
    return;
  }

  unsigned long now = millis();
  float dt = (now - lastTime) / 1000.0;
  lastTime = now;

  // Sharp turn if sensor 1 or 5 activated alone
  if (sensorReadings[0] == 1 && countDetected == 1) {
    // Sharp left turn
    setLeftMotor(-baseSpeed);
    setRightMotor(baseSpeed);
    lastDirection = -1;
    Serial.println("Sharp Left (Sensor 1)");
    return;
  }
  if (sensorReadings[4] == 1 && countDetected == 1) {
    // Sharp right turn
    setLeftMotor(baseSpeed);
    setRightMotor(-baseSpeed);
    lastDirection = 1;
    Serial.println("Sharp Right (Sensor 5)");
    return;
  }

  // Calculate PID error
  error = (float)positionSum / countDetected;

  // PID calculations
  integral += error * dt;
  float derivative = (error - lastError) / dt;
  float correction = Kp * error + Ki * integral + Kd * derivative;
  lastError = error;

  // Track last direction based on sensors 2, 3, 4 with soft turn logic
  if (sensorReadings[1] == 1) {
    lastDirection = -1;  // Soft left
  }
  else if (sensorReadings[2] == 1) {
    lastDirection = 0;   // Forward
  }
  else if (sensorReadings[3] == 1) {
    lastDirection = 1;   // Soft right
  }

  // Set motor speeds with PID and soft turns as one motor forward and other stopped
  int leftSpeed, rightSpeed;

  if (lastDirection == -1) {
    // Soft left: left motor STOPPED, right motor full speed
    leftSpeed = 0;
    rightSpeed = baseSpeed;
  } 
  else if (lastDirection == 1) {
    // Soft right: left motor full speed, right motor STOPPED
    leftSpeed = baseSpeed;
    rightSpeed = 0;
  }
  else {
    // Forward with PID correction
    leftSpeed = constrain(baseSpeed - (int)correction, 0, 255);
    rightSpeed = constrain(baseSpeed + (int)correction, 0, 255);
  }

  setLeftMotor(leftSpeed);
  setRightMotor(rightSpeed);

  Serial.print("Error: ");
  Serial.print(error);
  Serial.print(" Correction: ");
  Serial.print(correction);
  Serial.print(" LeftSpeed: ");
  Serial.print(leftSpeed);
  Serial.print(" RightSpeed: ");
  Serial.println(rightSpeed);

  delay(20);
}
